# mcp-w2vgrep

MCP server for semantic search using Word2Vec embeddings.

## Project Structure

```
src/
├── index.ts      # MCP server entry point, tool definition
└── utils.ts      # Parsing utilities for w2vgrep and ripgrep output
dist/             # Compiled JavaScript (generated by `npm run build`)
tests/            # Vitest tests
Dockerfile        # Multi-stage build (Go + Node.js)
docker-compose.yml
entrypoint.sh     # Model download script
```

## Build

```bash
npm run build                    # TypeScript → dist/
docker compose build             # Docker image
```

## Docker Architecture

Multi-stage build:
1. **golang:1.23-alpine** — builds w2vgrep from source
2. **node:20-alpine** — builds Node.js app
3. **node:20-alpine** — runtime (~70MB image)

### Volumes

| Host | Container | Description |
|------|-----------|-------------|
| `~/.config/semantic-grep` | `/app/models` | Word2Vec models (symlinked to `~/.config/semantic-grep` inside container) |
| Search directory | `/search` | Files to search (read-only) |

### Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `DOWNLOAD_MODELS` | `english` | Models to download: `english`, `russian`, `english,russian`, or `none` |
| `MODEL_DIR` | `/app/models` | Model storage directory |
| `W2VGREP_PATH` | `/usr/local/bin/w2vgrep` | Path to w2vgrep binary |

## MCP Tool Schema

### `semantic_search`

**Required:**
- `query` — search word (single word recommended, phrases may crash w2vgrep)
- `model_path` — `~/.config/semantic-grep/russian.bin` or `english.bin`

**Optional:**
- `threshold` — similarity (default 0.7). WARNING: < 0.5 returns MASSIVE data
- `glob` — file pattern (default `*.md`)
- `context` — lines around match (default 2, set 0 to reduce output)
- `ignore_case` — case-insensitive search

**Hardcoded (Docker):**
- path = `/search` (mounted volume)
- recursive = `true`

## Key Implementation Details

### Path Handling

Container uses symlinks for path compatibility:
- `/root/.config/semantic-grep` → `/app/models` (so `~/.config/semantic-grep/russian.bin` works)

### Search Flow

1. `w2vgrep` finds semantically similar text in concatenated files
2. `ripgrep` locates exact file positions for each match
3. Results merged and sorted by similarity

### Limitations

- **Single words only** — multi-word phrases can crash w2vgrep
- **Large output** — low threshold + recursive search = millions of characters
- **Model loading** — first query is slow (~5-10s) while model loads into memory

## Testing

```bash
# Manual test via Docker
echo '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{"protocolVersion":"2024-11-05","capabilities":{},"clientInfo":{"name":"test","version":"1.0"}}}
{"jsonrpc":"2.0","id":2,"method":"tools/call","params":{"name":"semantic_search","arguments":{"query":"test","model_path":"~/.config/semantic-grep/english.bin"}}}' | \
docker run --rm -i \
  -v ~/.config/semantic-grep:/app/models:ro \
  -v /path/to/files:/search:ro \
  -e DOWNLOAD_MODELS=none \
  mcp-w2vgrep-mcp-w2vgrep:latest
```

## Common Issues

### Empty results
- Check that files exist in `/search`
- Verify model path is correct
- Try higher threshold (0.7)

### Timeout/crash
- Query contains multiple words (use single word)
- Threshold too low (use 0.5+)

### Model not found
- Ensure volume mount is correct
- Check symlink: `~/.config/semantic-grep` → `/app/models`
